trigger:
- main

pool:
  vmImage: 'ubuntu-latest'
  name: 'Mac-Ubuntu2204'

steps:
# Reference the template for installing dependencies
# - template: templates/install_dependencies.yml

# Step to create the artifact
- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: 'parameters.yml'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'drop'
    publishLocation: 'Container'

# Step to download the artifact
- task: DownloadPipelineArtifact@2
  inputs:
    artifactName: 'drop'
    targetPath: '$(Pipeline.Workspace)/drop'
  displayName: 'Download Pipeline Artifacts'

# Step to convert YAML to JSON
- script: |
    cat $(Pipeline.Workspace)/drop/parameters.yml
    python -c "import yaml; f = open('$(Pipeline.Workspace)/drop/parameters.yml'); params = yaml.safe_load(f); f.close(); import json; print(json.dumps(params))" > params.json
    cat params.json
  displayName: 'Convert YAML to JSON'

# Step to run the Ansible playbook
- task: AzureCLI@2
  inputs:
    azureSubscription: 'srgovin29_subscription(7e9464cb-6d69-4edc-8ee0-613d543b56d0)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      RESOURCE_GROUP=$(jq -r '.rg_name' params.json)
      LOCATION=$(jq -r '.location' params.json)

      echo "RESOURCE_GROUP: $RESOURCE_GROUP"
      echo "LOCATION: $LOCATION"

      # Verify the Ansible version being used
      ansible --version

      # Run the Ansible playbook with specified Python interpreter
      ansible-playbook -i localhost, main.yml -e "rg_name=$RESOURCE_GROUP location=$LOCATION"
      #ansible-playbook -i localhost, main.yml -vvv -e "rg_name=$RESOURCE_GROUP location=$LOCATION" -e 'ansible_python_interpreter=/opt/hostedtoolcache/Python/3.10.12/x64/bin/python3'
  displayName: 'Run Ansible Playbook'
